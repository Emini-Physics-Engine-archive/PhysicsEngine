package at.emini.physics2D.util;

/**
 * Utilities for fixpoint math. 
 * <p>
 * The int values postfixed with FX represent decimal numbers:
 * The first 20 bit are before the dot, the least 12 ({@link FXUtil#DECIMAL} )bit represent everything after the decimal point.
 * So we have a precision of 2^-12 = 1/4096 <br>
 * Some small values also have "double precision". They are postfixed with 2FX and have 24 lower bits. 
 * <p>
 * Methods with FX in the name (e.g: setValueFX(...), getValueFX(...)) make use of the FX number representation.
 * That applies to both, input parameters and output parameters. 
 * <p>
 * To perform fixpoint arithmetic the following has to be considered:
 * Results from multiplication or division have to be shifted back into the correct place.
 * Here is sample usage of adding, subtracting, multiplying and dividing values:
 * <code>
 * int rFX = aFX + bFX; 
 * int rFX = aFX - bFX;
 * int rFX = FXUtil.multFX(aFX, bFX);
 * int rFX = FXUtil.divideFX(aFX, bFX);
 * </code> 
 * @author Alexander Adensamer
 */
public class FXUtil 
{
    /**
     * Lookup table for sinus calculation. <br>
     * Sample lookup code: <code>int sinFX = FXUtil.sinMatFX[rotation2FX >> 16]; </code> 
     * @fx
     */
    public static final short M_sinMatFX[] =
    {
        0,
        128,256,384,512,640,768,896,1024,1152,1280,1408,1535,1663,1791,1919,2047,
        2175,2302,2430,2558,2685,2813,2940,3068,3195,3323,3450,3577,3705,3832,3959,4086,
        4213,4340,4467,4594,4720,4847,4974,5100,5227,5353,5479,5606,5732,5858,5984,6109,
        6235,6361,6486,6612,6737,6862,6988,7113,7238,7362,7487,7612,7736,7861,7985,8109,
        8233,8357,8480,8604,8728,8851,8974,9097,9220,9343,9466,9588,9710,9833,9955,10077,
        10198,10320,10441,10563,10684,10805,10926,11046,11167,11287,11407,11527,11647,11766,11886,12005,
        12124,12243,12362,12480,12598,12716,12834,12952,13070,13187,13304,13421,13538,13654,13770,13887,
        14002,14118,14233,14349,14464,14578,14693,14807,14921,15035,15149,15262,15376,15489,15601,15714,
        15826,15938,16050,16161,16272,16383,16494,16605,16715,16825,16935,17044,17153,17262,17371,17480,
        17588,17696,17803,17911,18018,18125,18231,18337,18443,18549,18654,18759,18864,18969,19073,19177,
        19281,19384,19487,19590,19692,19795,19897,19998,20099,20200,20301,20401,20501,20601,20701,20800,
        20898,20997,21095,21193,21290,21388,21484,21581,21677,21773,21868,21964,22058,22153,22247,22341,
        22434,22528,22620,22713,22805,22897,22988,23079,23170,23260,23350,23440,23529,23618,23707,23795,
        23883,23970,24057,24144,24231,24317,24402,24487,24572,24657,24741,24825,24908,24991,25074,25156,
        25238,25319,25400,25481,25561,25641,25721,25800,25879,25957,26035,26113,26190,26266,26343,26419,
        26494,26569,26644,26719,26792,26866,26939,27012,27084,27156,27227,27298,27369,27439,27509,27578,
        27647,27716,27784,27851,27919,27986,28052,28118,28183,28249,28313,28377,28441,28505,28568,28630,
        28692,28754,28815,28876,28936,28996,29055,29114,29173,29231,29288,29346,29402,29459,29515,29570,
        29625,29679,29733,29787,29840,29893,29945,29997,30048,30099,30149,30199,30249,30298,30346,30394,
        30442,30489,30536,30582,30628,30673,30718,30762,30806,30849,30892,30935,30977,31018,31059,31100,
        31140,31180,31219,31257,31295,31333,31370,31407,31443,31479,31515,31549,31584,31618,31651,31684,
        31716,31748,31780,31811,31841,31871,31901,31930,31958,31986,32014,32041,32067,32093,32119,32144,
        32169,32193,32216,32240,32262,32284,32306,32327,32348,32368,32388,32407,32426,32444,32462,32479,
        32495,32512,32527,32543,32557,32572,32585,32599,32611,32624,32635,32646,32657,32667,32677,32686,
        32695,32703,32711,32718,32725,32731,32737,32742,32747,32751,32755,32758,32761,32763,32765,32766,
        32767,32767,32767,32766,32765,32763,32761,32758,32755,32751,32747,32742,32737,32731,32725,32718,
        32711,32703,32695,32686,32677,32667,32657,32646,32635,32624,32611,32599,32585,32572,32557,32543,
        32527,32512,32495,32479,32462,32444,32426,32407,32388,32368,32348,32327,32306,32284,32262,32240,
        32216,32193,32169,32144,32119,32093,32067,32041,32014,31986,31958,31930,31901,31871,31841,31811,
        31780,31748,31716,31684,31651,31618,31584,31549,31515,31479,31443,31407,31370,31333,31295,31257,
        31219,31180,31140,31100,31059,31018,30977,30935,30892,30849,30806,30762,30718,30673,30628,30582,
        30536,30489,30442,30394,30346,30298,30249,30199,30149,30099,30048,29997,29945,29893,29840,29787,
        29733,29679,29625,29570,29515,29459,29402,29346,29288,29231,29173,29114,29055,28996,28936,28876,
        28815,28754,28692,28630,28568,28505,28441,28377,28313,28249,28183,28118,28052,27986,27919,27851,
        27784,27716,27647,27578,27509,27439,27369,27298,27227,27156,27084,27012,26939,26866,26792,26719,
        26644,26569,26494,26419,26343,26266,26190,26113,26035,25957,25879,25800,25721,25641,25561,25481,
        25400,25319,25238,25156,25074,24991,24908,24825,24741,24657,24572,24487,24402,24317,24231,24144,
        24057,23970,23883,23795,23707,23618,23529,23440,23350,23260,23170,23079,22988,22897,22805,22713,
        22620,22528,22434,22341,22247,22153,22058,21964,21868,21773,21677,21581,21484,21388,21290,21193,
        21095,20997,20898,20800,20701,20601,20501,20401,20301,20200,20099,19998,19897,19795,19692,19590,
        19487,19384,19281,19177,19073,18969,18864,18759,18654,18549,18443,18337,18231,18125,18018,17911,
        17803,17696,17588,17480,17371,17262,17153,17044,16935,16825,16715,16605,16494,16384,16272,16161,
        16050,15938,15826,15714,15601,15489,15376,15262,15149,15035,14921,14807,14693,14578,14464,14349,
        14233,14118,14002,13887,13770,13654,13538,13421,13304,13187,13070,12952,12834,12716,12598,12480,
        12362,12243,12124,12005,11886,11766,11647,11527,11407,11287,11167,11046,10926,10805,10684,10563,
        10441,10320,10198,10077,9955,9833,9710,9588,9466,9343,9220,9097,8974,8851,8728,8604,
        8480,8357,8233,8109,7985,7861,7736,7612,7487,7362,7238,7113,6988,6862,6737,6612,
        6486,6361,6235,6109,5984,5858,5732,5606,5479,5353,5227,5100,4974,4847,4720,4594,
        4467,4340,4213,4086,3959,3832,3705,3577,3450,3323,3195,3068,2940,2813,2685,2558,
        2430,2302,2175,2047,1919,1791,1663,1535,1408,1280,1152,1024,896,768,640,512,
        384,256,128,0,-128,-256,-384,-512,-640,-768,-896,-1024,-1152,-1280,-1408,-1535,
        -1663,-1791,-1919,-2047,-2175,-2302,-2430,-2558,-2685,-2813,-2940,-3068,-3195,-3323,-3450,-3577,
        -3705,-3832,-3959,-4086,-4213,-4340,-4467,-4594,-4720,-4847,-4974,-5100,-5227,-5353,-5479,-5606,
        -5732,-5858,-5984,-6109,-6235,-6361,-6486,-6612,-6737,-6862,-6988,-7113,-7238,-7362,-7487,-7612,
        -7736,-7861,-7985,-8109,-8233,-8357,-8480,-8604,-8728,-8851,-8974,-9097,-9220,-9343,-9466,-9588,
        -9710,-9833,-9955,-10077,-10198,-10320,-10441,-10563,-10684,-10805,-10926,-11046,-11167,-11287,-11407,-11527,
        -11647,-11766,-11886,-12005,-12124,-12243,-12362,-12480,-12598,-12716,-12834,-12952,-13070,-13187,-13304,-13421,
        -13538,-13654,-13770,-13887,-14002,-14118,-14233,-14349,-14464,-14578,-14693,-14807,-14921,-15035,-15149,-15262,
        -15376,-15489,-15601,-15714,-15826,-15938,-16050,-16161,-16272,-16383,-16494,-16605,-16715,-16825,-16935,-17044,
        -17153,-17262,-17371,-17480,-17588,-17696,-17803,-17911,-18018,-18125,-18231,-18337,-18443,-18549,-18654,-18759,
        -18864,-18969,-19073,-19177,-19281,-19384,-19487,-19590,-19692,-19795,-19897,-19998,-20099,-20200,-20301,-20401,
        -20501,-20601,-20701,-20800,-20898,-20997,-21095,-21193,-21290,-21388,-21484,-21581,-21677,-21773,-21868,-21964,
        -22058,-22153,-22247,-22341,-22434,-22528,-22620,-22713,-22805,-22897,-22988,-23079,-23170,-23260,-23350,-23440,
        -23529,-23618,-23707,-23795,-23883,-23970,-24057,-24144,-24231,-24317,-24402,-24487,-24572,-24657,-24741,-24825,
        -24908,-24991,-25074,-25156,-25238,-25319,-25400,-25481,-25561,-25641,-25721,-25800,-25879,-25957,-26035,-26113,
        -26190,-26266,-26343,-26419,-26494,-26569,-26644,-26719,-26792,-26866,-26939,-27012,-27084,-27156,-27227,-27298,
        -27369,-27439,-27509,-27578,-27647,-27716,-27784,-27851,-27919,-27986,-28052,-28118,-28183,-28249,-28313,-28377,
        -28441,-28505,-28568,-28630,-28692,-28754,-28815,-28876,-28936,-28996,-29055,-29114,-29173,-29231,-29288,-29346,
        -29402,-29459,-29515,-29570,-29625,-29679,-29733,-29787,-29840,-29893,-29945,-29997,-30048,-30099,-30149,-30199,
        -30249,-30298,-30346,-30394,-30442,-30489,-30536,-30582,-30628,-30673,-30718,-30762,-30806,-30849,-30892,-30935,
        -30977,-31018,-31059,-31100,-31140,-31180,-31219,-31257,-31295,-31333,-31370,-31407,-31443,-31479,-31515,-31549,
        -31584,-31618,-31651,-31684,-31716,-31748,-31780,-31811,-31841,-31871,-31901,-31930,-31958,-31986,-32014,-32041,
        -32067,-32093,-32119,-32144,-32169,-32193,-32216,-32240,-32262,-32284,-32306,-32327,-32348,-32368,-32388,-32407,
        -32426,-32444,-32462,-32479,-32495,-32512,-32527,-32543,-32557,-32572,-32585,-32599,-32611,-32624,-32635,-32646,
        -32657,-32667,-32677,-32686,-32695,-32703,-32711,-32718,-32725,-32731,-32737,-32742,-32747,-32751,-32755,-32758,
        -32761,-32763,-32765,-32766,-32767,-32768,-32767,-32766,-32765,-32763,-32761,-32758,-32755,-32751,-32747,-32742,
        -32737,-32731,-32725,-32718,-32711,-32703,-32695,-32686,-32677,-32667,-32657,-32646,-32635,-32624,-32611,-32599,
        -32585,-32572,-32557,-32543,-32527,-32512,-32495,-32479,-32462,-32444,-32426,-32407,-32388,-32368,-32348,-32327,
        -32306,-32284,-32262,-32240,-32216,-32193,-32169,-32144,-32119,-32093,-32067,-32041,-32014,-31986,-31958,-31930,
        -31901,-31871,-31841,-31811,-31780,-31748,-31716,-31684,-31651,-31618,-31584,-31549,-31515,-31479,-31443,-31407,
        -31370,-31333,-31295,-31257,-31219,-31180,-31140,-31100,-31059,-31018,-30977,-30935,-30892,-30849,-30806,-30762,
        -30718,-30673,-30628,-30582,-30536,-30489,-30442,-30394,-30346,-30298,-30249,-30199,-30149,-30099,-30048,-29997,
        -29945,-29893,-29840,-29787,-29733,-29679,-29625,-29570,-29515,-29459,-29402,-29346,-29288,-29231,-29173,-29114,
        -29055,-28996,-28936,-28876,-28815,-28754,-28692,-28630,-28568,-28505,-28441,-28377,-28313,-28249,-28183,-28118,
        -28052,-27986,-27919,-27851,-27784,-27716,-27647,-27578,-27509,-27439,-27369,-27298,-27227,-27156,-27084,-27012,
        -26939,-26866,-26792,-26719,-26644,-26569,-26494,-26419,-26343,-26266,-26190,-26113,-26035,-25957,-25879,-25800,
        -25721,-25641,-25561,-25481,-25400,-25319,-25238,-25156,-25074,-24991,-24908,-24825,-24741,-24657,-24572,-24487,
        -24402,-24317,-24231,-24144,-24057,-23970,-23883,-23795,-23707,-23618,-23529,-23440,-23350,-23260,-23170,-23079,
        -22988,-22897,-22805,-22713,-22620,-22528,-22434,-22341,-22247,-22153,-22058,-21964,-21868,-21773,-21677,-21581,
        -21484,-21388,-21290,-21193,-21095,-20997,-20898,-20800,-20701,-20601,-20501,-20401,-20301,-20200,-20099,-19998,
        -19897,-19795,-19692,-19590,-19487,-19384,-19281,-19177,-19073,-18969,-18864,-18759,-18654,-18549,-18443,-18337,
        -18231,-18125,-18018,-17911,-17803,-17696,-17588,-17480,-17371,-17262,-17153,-17044,-16935,-16825,-16715,-16605,
        -16494,-16383,-16272,-16161,-16050,-15938,-15826,-15714,-15601,-15489,-15376,-15262,-15149,-15035,-14921,-14807,
        -14693,-14578,-14464,-14349,-14233,-14118,-14002,-13887,-13770,-13654,-13538,-13421,-13304,-13187,-13070,-12952,
        -12834,-12716,-12598,-12480,-12362,-12243,-12124,-12005,-11886,-11766,-11647,-11527,-11407,-11287,-11167,-11046,
        -10926,-10805,-10684,-10563,-10441,-10320,-10198,-10077,-9955,-9833,-9710,-9588,-9466,-9343,-9220,-9097,
        -8974,-8851,-8728,-8604,-8480,-8357,-8233,-8109,-7985,-7861,-7736,-7612,-7487,-7362,-7238,-7113,
        -6988,-6862,-6737,-6612,-6486,-6361,-6235,-6109,-5984,-5858,-5732,-5606,-5479,-5353,-5227,-5100,
        -4974,-4847,-4720,-4594,-4467,-4340,-4213,-4086,-3959,-3832,-3705,-3577,-3450,-3323,-3195,-3068,
        -2940,-2813,-2685,-2558,-2430,-2302,-2175,-2047,-1919,-1791,-1663,-1535,-1408,-1280,-1152,-1024,
        -896,-768,-640,-512,-384,-256,-128,0
    };
       
    /**
     * Shift Factor for single shifted numbers. 
     */
    public static final int DECIMAL = 12;
    /**
     * Shift Factor for double shifted numbers. 
     */
    public static final int DECIMAL2 = DECIMAL * 2;
    /**
     * Additional matrix shift factor. 
     */
    public static final int ADD_MATRIX_DECIMAL = 3;
    
    /**
     * Fixpoint Math representation of 1 (FX). 
     */
    public static final int ONE_FX = 1 << DECIMAL;  //#FX2F 

    /**
     * Fixpoint Math representation of 1 (2FX). 
     */
    public static final int ONE_2FX = 1 << DECIMAL2;  //#FX2F 

    /**
     * Fixpoint Math representation of Pi (2FX).<br>
     * The value computes to ~ 3.141592. 
     * @fx
     */
    public static final int PI_2FX = 52707178; //based on 2 * decimal 24 == 3.141592)

    /**
     * Fixpoint Math representation of 2*Pi (2FX).<br>
     * @fx
     */
    public static final int TWO_PI_2FX = 2 * PI_2FX;
    
    /**
     * Wraps an angle into the area [0..2*PI]. 
     * @fx
     * @param angle2FX the original angle(2FX). 
     * @return the wrapped angle (2FX). 
     */
    public static int wrapAngleFX(int angle2FX)
    {
        int wrappedAngle2FX = angle2FX;
        while(wrappedAngle2FX < 0) wrappedAngle2FX += FXUtil.TWO_PI_2FX;
        while(wrappedAngle2FX > FXUtil.TWO_PI_2FX) wrappedAngle2FX -= FXUtil.TWO_PI_2FX;
        return wrappedAngle2FX;
    }
    
    /**
     * Returns the difference of two angles [-PI..PI]. 
     * @fx
     * @param angle1_2FX first angle (2FX). 
     * @param angle2_2FX second angle (2FX).
     * @return the angle between them (2FX).
     */
    public static int angleDiffFX(int angle1_2FX, int angle2_2FX)
    {
        int diff2FX = angle2_2FX - angle1_2FX;
        while(diff2FX < - PI_2FX) diff2FX += FXUtil.TWO_PI_2FX;
        while(diff2FX >   PI_2FX) diff2FX -= FXUtil.TWO_PI_2FX;
        return diff2FX;
    }
    
    /**
     * Returns the angle in degrees  
     * @fx
     * @param angle2FX angle to convert (2FX). 
     * @return the angle converted to degrees.
     */
    public static int angleInDegrees2FX(long angle2FX)
    {
        return (int) ((angle2FX * 180)/ FXUtil.PI_2FX);
    } 
 
    /**
     * Multiplication of two fixpoint values. 
     * @fx
     * @param aFX value a to multiply (FX).
     * @param bFX value b to multiply (FX).
     * @return the product (FX).
     */
    public static int multFX(int aFX, int bFX)
    {
        return (int) (((long)aFX * (long) bFX) >> FXUtil.DECIMAL);
    } 
    
    /**
     * Multiplication of two fixpoint values.
     * Long version 
     * @fx
     * @param aFX value a to multiply (FX).
     * @param bFX value b to multiply (FX).
     * @return the product (FX).
     */
    public static long multFX(long aFX, long bFX)           //#FX2F
    {                                                       //#FX2F
        return (int) ((aFX * bFX) >> FXUtil.DECIMAL);       //#FX2F
    }                                                       //#FX2F
    
    /**
     * Division of two fixpoint values. 
     * @fx
     * @param aFX value a to multiply (FX).
     * @param bFX value b to multiply (FX).
     * @return the result of the division (FX).
     */
    public static int divideFX(int aFX, int bFX)
    {
        return (int) (((long)aFX << FXUtil.DECIMAL) / bFX) ;
    } 
    
    /**
     * Division of two fixpoint values.
     * Long version 
     * @fx
     * @param aFX value a to multiply (FX).
     * @param bFX value b to multiply (FX).
     * @return the result of the division (FX).
     */
    public static long divideFX(long aFX, long bFX)         //#FX2F
    {                                                       //#FX2F
        return (int) ((aFX << FXUtil.DECIMAL) / bFX) ;      //#FX2F
    }                                                       //#FX2F
    
    /**
     * Converts a value to fixpoint value (shifting). 
     * @param value the value to convert. 
     * @return the fixpoint value (FX). 
     */
    public static int toFX(int value)
    {
        return value << FXUtil.DECIMAL;
    }
    
    /**
     * Converts a fixpoint value to integer
     * @param valueFX the fixpoint value (FX)
     * @return the integer value 
     */
    public static int fromFX(int valueFX)
    {
        return valueFX >> FXUtil.DECIMAL;
    }
}
